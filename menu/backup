#!/bin/bash

MODE="manual"
CUSTOM_PASS=""
for arg in "$@"; do
  case $arg in
    --auto)
      MODE="auto"
      ;;
    --password=*)
      CUSTOM_PASS="${arg#*=}"
      ;;
  esac
done

eval $(wget -qO- https://domainsaya.dekaa.my.id)
ipsaya=$(curl -sS ipv4.icanhazip.com)
data_server=$(curl -v --insecure --silent https://google.com/ 2>&1 | grep Date | sed -e 's/< Date: //')
date_list=$(date +"%Y-%m-%d" -d "$data_server")
data_ip="https://raw.githubusercontent.com/diah082/izin/main/ip"
domain=$(cat /etc/xray/domain)

checking_sc() {
  useexp=$(wget -qO- $data_ip | grep -wE $ipsaya | awk '{print $3}')
  if [[ "$useexp" == "Lifetime" ]]; then return; fi
  date_list_epoch=$(date -d "$date_list" +%s)
  useexp_epoch=$(date -d "$useexp" +%s 2>/dev/null)
  [[ $? -ne 0 || $date_list_epoch -gt $useexp_epoch ]] && {
    echo -e "SCRIPT LOCKED - Expired!"
    exit 1
  }
}
checking_sc

# Output echo hanya di mode manual
if [[ "$MODE" == "manual" ]]; then
  echo "ğŸ“ Membuat direktori backup..."
fi
rm -rf /root/backup
mkdir /root/backup

[[ "$MODE" == "manual" ]] && echo "ğŸ“¦ Menyalin file konfigurasi..."
cp /etc/passwd /root/backup/
cp /etc/group /root/backup/
cp /etc/shadow /root/backup/
cp /etc/gshadow /root/backup/
cp /etc/crontab /root/backup/
cp /etc/vmess/.vmess.db /root/backup/
cp /etc/ssh/.ssh.db /root/backup/
cp /etc/vless/.vless.db /root/backup/
cp /etc/trojan/.trojan.db /root/backup/
cp /etc/bot/.bot.db /root/backup/
cp -r /etc/kyt/limit /root/backup/
cp -r /etc/limit /root/backup/qt/
cp -r /etc/vmess /root/backup/
cp -r /etc/trojan /root/backup/
cp -r /etc/vless /root/backup/
cp -r /var/lib/kyt/ /root/backup/kyt
cp -r /etc/xray /root/backup/xray
cp -r /var/www/html/ /root/backup/html

IP=$(curl -sS ipv4.icanhazip.com)
date=$(date +"%Y-%m-%d")
backup_pw="${CUSTOM_PASS:-$(tr -dc 'A-Za-z0-9' </dev/urandom | head -c 6)}"

[[ "$MODE" == "manual" ]] && echo "ğŸ—œï¸  Membuat file backup.zip dengan password..."
cd /root
7z a -tzip -p"$backup_pw" -mem=AES256 /root/backup.zip backup > /dev/null 2>&1

if [[ "$MODE" == "auto" ]]; then
  echo "$backup_pw" > /root/backup_password.txt
  echo "âœ… Backup selesai (auto mode). File: /root/backup.zip"
  echo "ğŸ” Password: $backup_pw"
  mkdir -p /opt/backup-restore-ui/temp
  cp backup.zip /root/$IP.zip
  echo "ğŸ“¤ Mengirim backup ke Telegram..."

  curl -F chat_id="$CHATID" -F document=@"$IP.zip" https://api.telegram.org/bot$KEYBK/sendDocument > /dev/null 2>&1
  curl -s -X POST "https://api.telegram.org/bot$KEYBK/sendMessage" \
    -F chat_id="$CHATID" \
    -F text="â—‡â”â”â”â”â”â”â”â”â”â”â”â”â”â”â—‡
âš ï¸Detail Backup VPSâš ï¸
â—‡â”â”â”â”â”â”â”â”â”â”â”â”â”â”â—‡
IP VPS  : <code>${IP}</code>
DOMAIN  : <code>${domain}</code>
Tanggal : <code>${date}</code>
Pass    : <code>${backup_pw}</code>
â—‡â”â”â”â”â”â”â”â”â”â”â”â”â”â”â—‡
Silahkan upload file restore di VPS baru
BY BOT : @Newbie_Store24" \
    -F parse_mode="HTML" > /dev/null 2>&1

  mv /root/backup.zip /opt/backup-restore-ui/temp/backup.zip
  rm -rf /root/backup
  rm -rf /root/$IP.zip
  exit 0
fi


[[ "$MODE" == "manual" ]] && echo "â˜ï¸ Mengupload ke Google Drive..."
7z a -tzip -p"$backup_pw" "$IP.zip" backup > /dev/null 2>&1
7z a -tzip -p"$backup_pw" "$IP-$date.zip" backup > /dev/null 2>&1
backup_file="/root/$IP-$date.zip"
remote_path="dr:backup/$IP-$date.zip"
max_retry=3

upload_backup() {
  local attempt=1
  while [[ $attempt -le $max_retry ]]; do
    rclone copy "$backup_file" "dr:backup/"
    url=$(rclone link "$remote_path")
    id=$(echo "$url" | grep '^https' | cut -d'=' -f2)
    if [[ -n "$id" ]]; then
      echo "$backup_pw" > /root/$id.txt
      return 0
    fi
    sleep 5
    ((attempt++))
  done
  echo "$0" | at now + 30 minutes
  exit 1
}
upload_backup

pass_backup="/root/$id.txt"
upload_pass() {
  local attempt=1
  while [[ $attempt -le $max_retry ]]; do
    rclone copy "$pass_backup" "pass:pass/"
    sleep 1
    [[ $(rclone ls res:pass/ | grep -c $id.txt) -gt 0 ]] && return 0
    sleep 5
    ((attempt++))
  done
  echo "$0" | at now + 5 minutes
  exit 1
}
upload_pass

rm $pass_backup
rm -rf /root/backup

[[ "$MODE" == "manual" ]] && echo "ğŸ“¤ Mengirim backup ke Telegram..."

curl -F chat_id="$CHATID" -F document=@"$IP.zip" https://api.telegram.org/bot$KEYBK/sendDocument > /dev/null 2>&1
curl -s -X POST "https://api.telegram.org/bot$KEYBK/sendMessage" \
  -F chat_id="$CHATID" \
  -F text="â—‡â”â”â”â”â”â”â”â”â”â”â”â”â”â”â—‡
âš ï¸Detail Backup VPSâš ï¸
â—‡â”â”â”â”â”â”â”â”â”â”â”â”â”â”â—‡
IP VPS  : <code>${IP}</code>
DOMAIN  : <code>${domain}</code>
Tanggal : <code>${date}</code>
Pass    : <code>${backup_pw}</code>
â—‡â”â”â”â”â”â”â”â”â”â”â”â”â”â”â—‡
ID Backup   : <code>${id}</code>
â—‡â”â”â”â”â”â”â”â”â”â”â”â”â”â”â—‡
Silahkan copy ID dan restore di VPS baru
BY BOT : @Newbie_Store24" \
  -F parse_mode="HTML" > /dev/null 2>&1

rm -r /root/$IP.zip
rm -r /root/$IP-$date.zip

[[ "$MODE" == "manual" ]] && echo "âœ… Backup Manual Berhasil!"
clear
if [[ "$MODE" == "manual" ]]; then
  echo ""
  echo -e "\e[38;5;99m======================================\e[0m"
  echo -e "\e[35m            \e[33mBACKUP DATA VPS\e[35m             \e[0m"
  echo -e "\e[38;5;99m======================================\e[0m"
  echo -e "\e[35m            \e[37mSuccessfully\e[0m"
  echo -e "\e[38;5;99m======================================\e[0m"
  echo -e "\e[35m ID FILE      : \e[37m $id \e[0m"
  echo -e "\e[38;5;99m======================================\e[0m"
  echo -e "\e[35m IN DATE      : \e[37m $date \e[0m"
  echo -e "\e[35m DOMAIN       : \e[37m ${domain} \e[0m"
  echo -e "\e[35m IP VPS       : \e[37m $IP \e[0m"
  echo -e "\e[35m PASS         : \e[37m $backup_pw \e[0m"
  echo -e "\e[38;5;99m======================================\e[0m"
  echo -e "\e[37m Please copy the backup ID\e[0m"
  echo -e "\e[37m paste link on the new VPS\e[0m"
  echo -e "\e[38;5;99m======================================\e[0m"
  echo ""
fi
